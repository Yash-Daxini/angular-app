<div class="container-fluid py-4 bg-light min-vh-100">
  <div class="container">
    <!-- Header Section -->
    <div class="row mb-5">
      <div class="col-12">
        <div class="text-center">
          <h1 class="display-4 fw-bold text-primary mb-3">
            <i class="fas fa-clipboard-list me-3"></i>Your Ordered Products
          </h1>
          <p class="lead text-muted">
            Rate and review the delicious items you've enjoyed
          </p>
        </div>
      </div>
    </div>

    <!-- Controls Section -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card shadow-sm border-0 controls-card">
          <div class="card-body">
            <!-- Category Filter -->
            <div class="row align-items-center">
              <div class="col-md-8">
                <h6 class="mb-2 text-muted">Filter by Category:</h6>
                <div class="d-flex flex-wrap gap-2">
                  <button
                    *ngFor="let category of categories"
                    type="button"
                    class="btn filter-btn"
                    [class.active]="selectedCategory === category"
                    (click)="filterByCategory(category)"
                  >
                    <i
                      *ngIf="category !== 'all'"
                      [class]="getCategoryIcon(category)"
                      class="me-1"
                    ></i>
                    {{ category | titlecase }}
                  </button>
                </div>
              </div>
              <div class="col-md-4">
                <div class="text-md-end mt-3 mt-md-0">
                  <span class="badge bg-primary px-3 py-2 fs-6">
                    <i class="fas fa-list me-1"></i
                    >{{ filteredProducts.length }} Products
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Products Table -->
    <div class="row">
      <div class="col-12">
        <div class="card shadow-sm border-0">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover products-table mb-0">
                <thead class="table-header">
                  <tr>
                    <th
                      scope="col"
                      class="sortable-header"
                      (click)="onSort('name')"
                    >
                      <i class="fas fa-utensils me-2"></i>Product
                      <i class="fas fa-sort ms-2 sort-icon"></i>
                    </th>
                    <th
                      scope="col"
                      class="sortable-header text-center"
                      (click)="onSort('price')"
                    >
                      <i class="fas fa-dollar-sign me-1"></i>Price
                      <i class="fas fa-sort ms-2 sort-icon"></i>
                    </th>
                    <th
                      scope="col"
                      class="sortable-header text-center"
                      (click)="onSort('rating')"
                    >
                      <i class="fas fa-star me-1"></i>Rating
                      <i class="fas fa-sort ms-2 sort-icon"></i>
                    </th>
                    <th
                      scope="col"
                      class="sortable-header text-center"
                      (click)="onSort('orderCount')"
                    >
                      <i class="fas fa-shopping-cart me-1"></i>Orders
                      <i class="fas fa-sort ms-2 sort-icon"></i>
                    </th>
                    <th
                      scope="col"
                      class="sortable-header text-center"
                      (click)="onSort('lastOrdered')"
                    >
                      <i class="fas fa-calendar me-1"></i>Last Ordered
                      <i class="fas fa-sort ms-2 sort-icon"></i>
                    </th>
                    <th scope="col" class="text-center">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <ng-container
                    *ngFor="
                      let product of filteredProducts;
                      trackBy: trackByProduct
                    "
                  >
                    <!-- Main Product Row -->
                    <tr
                      class="product-row"
                      [class.expanded]="isRowExpanded(product.id)"
                    >
                      <td class="product-info">
                        <div class="d-flex align-items-center">
                          <div class="category-icon me-3">
                            <i
                              [class]="getCategoryIcon(product.category)"
                              class="fs-4"
                            ></i>
                          </div>
                          <div>
                            <h6 class="product-name mb-1">
                              {{ product.name }}
                            </h6>
                            <p class="product-description mb-0">
                              {{ product.description }}
                            </p>
                            <span class="badge category-badge mt-1">{{
                              product.category
                            }}</span>
                          </div>
                        </div>
                      </td>
                      <td class="text-center align-middle">
                        <span class="price-display"
                          >${{ product.price | number : "1.2-2" }}</span
                        >
                      </td>
                      <td class="text-center align-middle">
                        <div class="rating-display">
                          <div class="stars-compact mb-1">
                            <span
                              *ngFor="let star of getStarArray(5)"
                              class="star-icon"
                              [class.filled]="star <= product.rating"
                            >
                              <i class="fas fa-star"></i>
                            </span>
                          </div>
                          <small class="rating-text"
                            >{{ product.rating | number : "1.1-1" }} ({{
                              product.totalRatings
                            }})</small
                          >
                          <br />
                          <span
                            class="badge rating-quality-badge"
                            [class]="getRatingClass(product.rating)"
                          >
                            {{ getRatingText(product.rating) }}
                          </span>
                        </div>
                      </td>
                      <td class="text-center align-middle">
                        <span class="order-count-badge"
                          >{{ product.orderCount }}x</span
                        >
                      </td>
                      <td class="text-center align-middle">
                        <small class="text-muted">{{
                          product.lastOrdered | date : "MMM dd, yyyy"
                        }}</small>
                      </td>
                      <td class="text-center align-middle">
                        <button
                          class="btn btn-outline-primary btn-sm action-btn"
                          (click)="toggleRow(product.id)"
                        >
                          <i
                            class="fas"
                            [class.fa-chevron-down]="!isRowExpanded(product.id)"
                            [class.fa-chevron-up]="isRowExpanded(product.id)"
                          ></i>
                          {{
                            isRowExpanded(product.id) ? "Hide" : "Rate & Review"
                          }}
                        </button>
                      </td>
                    </tr>

                    <!-- Expanded Rating & Feedback Row -->
                    <tr *ngIf="isRowExpanded(product.id)" class="expanded-row">
                      <td colspan="6" class="expanded-content">
                        <div class="row g-4 py-3">
                          <!-- Rating Section -->
                          <div class="col-md-6">
                            <div class="rating-section">
                              <h6 class="section-title">
                                <i
                                  class="fas fa-star-half-alt me-2 text-warning"
                                ></i
                                >Rate this product
                              </h6>
                              <div class="rating-input-container">
                                <div class="stars-input mb-3">
                                  <span
                                    *ngFor="let star of getStarArray(5)"
                                    class="star-input"
                                    [class.active]="star <= product.userRating"
                                    (click)="setRating(product, star)"
                                  >
                                    <i class="fas fa-star"></i>
                                  </span>
                                </div>
                                <button
                                  class="btn btn-warning btn-sm px-4"
                                  (click)="submitRating(product)"
                                >
                                  <i class="fas fa-paper-plane me-1"></i>Submit
                                  Rating
                                </button>
                              </div>
                            </div>
                          </div>

                          <!-- Feedback Section -->
                          <div class="col-md-6">
                            <div class="feedback-section">
                              <h6 class="section-title">
                                <i class="fas fa-comment me-2 text-info"></i
                                >Share your feedback
                              </h6>
                              <div class="feedback-input-container">
                                <textarea
                                  class="form-control mb-3"
                                  rows="3"
                                  placeholder="Tell us what you think about this product..."
                                  [(ngModel)]="product.feedback"
                                ></textarea>
                                <button
                                  class="btn btn-info btn-sm px-4"
                                  (click)="submitFeedback(product)"
                                >
                                  <i class="fas fa-paper-plane me-1"></i>Submit
                                  Feedback
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </td>
                    </tr>
                  </ng-container>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div class="row" *ngIf="filteredProducts.length === 0">
      <div class="col-12">
        <div class="text-center py-5">
          <i class="fas fa-search fa-3x text-muted mb-3"></i>
          <h4 class="text-muted">No products found</h4>
          <p class="text-muted">Try selecting a different category</p>
        </div>
      </div>
    </div>
  </div>
</div>
